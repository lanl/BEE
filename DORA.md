# Launching BEE on Dora/OpenStack

## Install

When installing BEE with poetry, you'll need to make sure that the
`cloud_extras` packages are installed. To do this run

`poetry install -E cloud_extras`

## Configuration

Most of the configuration for the cloud launcher script will be under the
`[cloud]` section in the bee.conf. Here are the required parameters. These are
not necessarily unique to Dora, but can also apply to GCE and other clouds if
supported in the future.

* `private_key_file`: path to the private key file used for the head instance
* `bee_user`: user to be created on head instance (most likely the default user
   created -- cloud-user for RHEL and debian for debian images)
* `tm_listen_port`: listening port of the remote TM
* `wfm_listen_port`: listening port of the local WFM
* `head_node`: name of the head node where the TM will be launched
* `template_file`: path to the template file to launch the cloud setup from
* `provider`: name of provider (`google`, `openstack`, `chameleoncloud`)
* `tm_launch_cmd`: path to a script generated by the template. This is `/bee/tm`
  for the default Dora template.

As an example here is the current configuration that I'm using on my account:

```
[cloud]
private_key_file = /home/jtronge/key
bee_user = debian
tm_listen_port = 7777
tm_launch_cmd = /bee/tm
head_node = bee-server
template_file = /home/jtronge/BEE_Private/templates/dora-template.yaml
provider = openstack
```

### Provider Specific Configuration

In order to launch stacks with different templates and providers, there is an
extra section which corresponds to a given provider. The section is named
`[cloud.{provider}]` where provider is the provider name in lowercase. The
contents of the section vary depending on the provider class and the template
being used.

For the `templates/dora-template.yaml` here are the required parameters:

* `stack_name`: name of the stack to be created
* `key_name`: name of the key, as shown in OpenStack
* `public_net`: public network name (external for Dora)
* `github_pat`: this is a GitHub PAT credential (see [Creating a personal access token](https://docs.github.com/en/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token)).
  This is needed to clone the BEE repo on the instance. Once BEE is public this won't be necessary.
* `git_branch`: branch of BEE to check out (`milestone-cloud`)
* `https_proxy`: HTTPS proxy env value (same as do-sn1)
* `http_proxy`: HTTP proxy env value (same as do-sn1)
* `no_proxy`: no proxy value (same as do-sn1)
* `wfm_listen_port`: listen port of the current WFM
* `tm_listen_port`: listen port of the remote TM
* `copy_files`: a list of `src_file:dest_dir` pairs separated by commas. I use
  this to easily copy containers over to the instance
    * Ex. `copy_files = /home/jtronge/heat-transfer.tar.gz:/home/debian,/home/jtronge/clamr.tar.gz:/home/debian`

Some of these values make the config slightly redundant (like the
`wfm_listen_port` value), but it makes it easier to launch the template by just
passing the complete key-value pairs of the provider section on template
creation.

Also, for OpenStack on Dora, the BEE image is based on a Debian 10 openstack
image which can be downloaded [here](http://cloud.debian.org/images/cloud/OpenStack/current-10/).
The [debian-10-openstack-amd64.qcow2](http://cloud.debian.org/images/cloud/OpenStack/current-10/debian-10-openstack-amd64.qcow2)
image should work with the template.

## Launch Script

The cloud launcher script assumes that the openstack environment variables are
already properly set by running the typical rc script. Once that is done,
to set up the actual stack from the template file, you can run:

`python -m beeflow.cloud_launcher --setup-cloud [CONFIG FILE]`

To facilitate moving data onto the instances, I've included a `--copy` option
that copies files listed in the `copy_files` parameter of the config. I've been
using this to copy over pre-built containers to the instances.

After doing a couple test runs, I've noticed that the BEE install step
sometimes takes longer than expected. After the `--setup-cloud` option has run
and returned, `poetry install` will likely still be running on the instance.
So, before running the Task Manager, you may have to wait for 5-10 minutes at
a minimum.

## Running BEE

First the GDB and the scheduler will need to be started as usual with
`beeflow --gdb --sched`. The Workflow Manager could probably be started this
way as well, but it's easier to launch it manually to see the debug output.
To launch the workflow manager you also need to make sure that `$no_proxy`
includes localhost, since this is how the WFM contacts the TM.

`no_proxy=localhost,$no_proxy python -m beeflow.wf_manager ~/.config/beeflow/bee.conf`

To launch the Task Manager, I've included an option in my cloud launcher script
which starts it and then sets up an SSH tunnel to the local machine. Run this:

`python -m beeflow.cloud_launcher --tm [CONFIG FILE]`

This will show the debug output of the TM on the remote system and should also
show the output of running individual steps.

I've created a modified version of the client to quickly launch workflows
directly from the command line or a script.  You can run
`./src/beeflow/client/client_cli.py --workflow-path [PATH TO WORKFLOW]`, or use
the original client.py script.
